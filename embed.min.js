(function() {
    if (!window.embeddedChatbotConfig) {
        console.error("embeddedChatbotConfig is required. Make sure it is defined before this script.");
        return;
    }

    const defaultConfig = {
        size: {
            width: "450px",
            height: "600px",
        },
        chat: {
            size: "52px",
            logo: "https://221160ec90288b67394305daa4da6352.cdn.bubble.io/f1737572394496x724354314179088600/embedlogo.png",
            activeLogo: "https://221160ec90288b67394305daa4da6352.cdn.bubble.io/f1737572400429x992379412088643600/embedarrow.png",
            position: "right",
        },
        domain: "app.attlaslabs.com",
        environment: "",
    };

    const config = {...defaultConfig, ...window.embeddedChatbotConfig};
    const environmentPath = config.environment === "version-test" ? "/version-test" : "";

    const existingIframe = document.querySelector(`iframe[src*="${config.chatbotId}"]`);
    if (existingIframe) {
        console.warn("An iframe with this chatbotId already exists.");
        return;
    }

    const chat = document.createElement("div");
    chat.style.position = "fixed";
    chat.style.bottom = "20px";
    chat.style[config.chat.position] = "20px";
    chat.style.width = config.chat.size;
    chat.style.height = config.chat.size;
    chat.style.borderRadius = "50%";
    chat.style.display = "flex";
    chat.style.alignItems = "center";
    chat.style.justifyContent = "center";
    chat.style.cursor = "pointer";
    chat.style.transition = "transform 0.3s ease, opacity 0.3s ease";
    chat.style.zIndex = "999999";

    const chatLogo = document.createElement("img");
    chatLogo.src = config.chatLogo || config.chat.logo;
    chatLogo.style.width = "100%";
    chatLogo.style.height = "100%";
    chatLogo.style.borderRadius = "50%";
    chatLogo.style.objectFit = "cover";
    chat.appendChild(chatLogo);

    chat.addEventListener("mouseenter", () => {
        chat.style.transform = "scale(1.1)";
    });

    chat.addEventListener("mouseleave", () => {
        chat.style.transform = "scale(1)";
    });

    document.body.appendChild(chat);

    const iframe = document.createElement("iframe");
    iframe.src = `https://${config.domain}${environmentPath}/iframe/${config.chatbotId}`;
    iframe.style.position = "fixed";
    iframe.style.bottom = `${parseInt(config.chat.size, 10) + 30}px`;
    iframe.style[config.chat.position] = "10px";
    iframe.style.width = config.size.width;
    iframe.style.height = config.size.height;
    iframe.style.border = "0";
    iframe.style.zIndex = "999998";
    iframe.style.boxShadow = "0px 4px 6px rgba(0, 0, 0, 0.1)";
    iframe.style.borderRadius = "10px";
    iframe.style.transition = "transform 0.3s ease, opacity 0.3s ease, bottom 0.3s ease";
    iframe.style.transform = "scale(0.8)";
    iframe.style.opacity = "0";
    iframe.style.pointerEvents = "none";
    iframe.style.bottom = "0";
    document.body.appendChild(iframe);

    let isOpen = false;

    function openIframe() {
        iframe.style.transform = "scale(1)";
        iframe.style.opacity = "1";
        iframe.style.pointerEvents = "auto";
        iframe.style.bottom = `${parseInt(config.chat.size, 10) + 30}px`;
        chatLogo.src = config.activeChatLogo || config.chat.activeLogo;
        isOpen = true;
    }

    function closeIframe() {
        iframe.style.transform = "scale(0.8)";
        iframe.style.opacity = "0";
        iframe.style.pointerEvents = "none";
        iframe.style.bottom = "0";
        chatLogo.src = config.chatLogo || config.chat.logo;
        isOpen = false;
    }

    chat.addEventListener("click", () => {
        isOpen ? closeIframe() : openIframe();
    });
})();
