(function () {
    if (!window.embeddedChatbotConfig) {
        console.error("embeddedChatbotConfig non défini !");
        return;
    }

    const config = window.embeddedChatbotConfig;

    // Valeurs par défaut
    const defaultConfig = {
        size: {
            width: "450px",
            height: "630px",
        },
        bubble: {
            size: "52px", // Taille de la bulle
            logo: "https://via.placeholder.com/52", // Image initiale (fermé)
            activeLogo: "https://via.placeholder.com/52/arrow-down", // Image ouverte
            position: config.position === "left" ? "left" : "right",
        },
        domain: config.domain || "www.attlaslabs.com",
    };

    // Créer la bulle d'ouverture
    const bubble = document.createElement("div");
    bubble.style.position = "fixed";
    bubble.style.bottom = "20px";
    bubble.style[defaultConfig.bubble.position] = "20px";
    bubble.style.width = defaultConfig.bubble.size;
    bubble.style.height = defaultConfig.bubble.size;
    bubble.style.borderRadius = "50%";
    bubble.style.display = "flex";
    bubble.style.alignItems = "center";
    bubble.style.justifyContent = "center";
    bubble.style.cursor = "pointer";
    bubble.style.transition = "transform 0.3s ease";
    bubble.style.zIndex = "999999";

    // Ajouter l'image de la bulle
    const bubbleLogo = document.createElement("img");
    bubbleLogo.src = config.bubbleLogo || defaultConfig.bubble.logo;
    bubbleLogo.style.width = "100%";
    bubbleLogo.style.height = "100%";
    bubbleLogo.style.borderRadius = "50%";
    bubbleLogo.style.objectFit = "cover";
    bubble.appendChild(bubbleLogo);

    // Animation au hover
    bubble.addEventListener("mouseenter", () => {
        bubble.style.transform = "scale(1.1)";
    });

    bubble.addEventListener("mouseleave", () => {
        bubble.style.transform = "scale(1)";
    });

    document.body.appendChild(bubble);

    // Créer l'iframe
    const iframe = document.createElement("iframe");
    iframe.src = `https://${defaultConfig.domain}/version-test/iframe/${config.chatbotId}`;
    iframe.style.position = "fixed";
    iframe.style.bottom = "10px";
    iframe.style[defaultConfig.bubble.position] = "10px";
    iframe.style.width = defaultConfig.size.width;
    iframe.style.height = defaultConfig.size.height;
    iframe.style.border = "0";
    iframe.style.zIndex = "999998";
    iframe.style.boxShadow = "0px 4px 6px rgba(0, 0, 0, 0.1)";
    iframe.style.borderRadius = "10px";
    iframe.style.transition = "transform 0.3s ease, opacity 0.3s ease";
    iframe.style.transform = "scale(0.8)";
    iframe.style.opacity = "0";
    iframe.style.pointerEvents = "none"; // Désactiver les interactions quand masqué
    document.body.appendChild(iframe);

    // Gérer les clics pour afficher ou masquer l'iframe
    let isOpen = false;
    bubble.addEventListener("click", () => {
        isOpen = !isOpen;
        if (isOpen) {
            iframe.style.transform = "scale(1)";
            iframe.style.opacity = "1";
            iframe.style.pointerEvents = "auto";
            bubbleLogo.src = config.activeBubbleLogo || defaultConfig.bubble.activeLogo; // Change l'image (ouvert)
        } else {
            iframe.style.transform = "scale(0.8)";
            iframe.style.opacity = "0";
            iframe.style.pointerEvents = "none";
            bubbleLogo.src = config.bubbleLogo || defaultConfig.bubble.logo; // Reviens à l'image initiale (fermé)
        }
    });
})();