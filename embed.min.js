(function () {
    if (!window.embeddedChatbotConfig) {
        console.error("embeddedChatbotConfig est requis. Assurez-vous qu'il est défini avant ce script.");
        return;
    }

    const defaultConfig = {
        size: {
            width: "450px",
            height: "630px",
        },
        bubble: {
            size: "52px",
            logo: "https://221160ec90288b67394305daa4da6352.cdn.bubble.io/f1737572394496x724354314179088600/embedlogo.png",
            activeLogo: "https://221160ec90288b67394305daa4da6352.cdn.bubble.io/f1737572400429x992379412088643600/embedarrow.png",
            position: "right",
        },
        domain: "app.attlaslabs.com",
        environment: "",
    };

    const config = { ...defaultConfig, ...(window.embeddedChatbotConfig || {}) };

    const environmentPath = config.environment === "version-test" ? "/version-test" : "";

    const existingIframe = document.querySelector(`iframe[src*="${config.chatbotId}"]`);
    if (existingIframe) {
        console.warn("Un iframe avec ce chatbotId existe déjà.");
        return;
    }

    const bubble = document.createElement("div");
    bubble.style.position = "fixed";
    bubble.style.bottom = "20px";
    bubble.style[config.bubble.position] = "20px";
    bubble.style.width = config.bubble.size;
    bubble.style.height = config.bubble.size;
    bubble.style.borderRadius = "50%";
    bubble.style.display = "flex";
    bubble.style.alignItems = "center";
    bubble.style.justifyContent = "center";
    bubble.style.cursor = "pointer";
    bubble.style.transition = "transform 0.3s ease";
    bubble.style.zIndex = "999999";

    const bubbleLogo = document.createElement("img");
    bubbleLogo.src = config.bubbleLogo || config.bubble.logo;
    bubbleLogo.style.width = "100%";
    bubbleLogo.style.height = "100%";
    bubbleLogo.style.borderRadius = "50%";
    bubbleLogo.style.objectFit = "cover";
    bubble.appendChild(bubbleLogo);

    bubble.addEventListener("mouseenter", () => {
        bubble.style.transform = "scale(1.1)";
    });

    bubble.addEventListener("mouseleave", () => {
        bubble.style.transform = "scale(1)";
    });

    document.body.appendChild(bubble);

    const iframe = document.createElement("iframe");
    iframe.src = `https://${config.domain}${environmentPath}/iframe/${config.chatbotId}`;
    iframe.style.position = "fixed";
    iframe.style.bottom = "10px";
    iframe.style[config.bubble.position] = "10px";
    iframe.style.width = config.size.width;
    iframe.style.height = config.size.height;
    iframe.style.border = "0";
    iframe.style.zIndex = "999998";
    iframe.style.boxShadow = "0px 4px 6px rgba(0, 0, 0, 0.1)";
    iframe.style.borderRadius = "10px";
    iframe.style.transition = "transform 0.3s ease, opacity 0.3s ease";
    iframe.style.transform = "scale(0.8)";
    iframe.style.opacity = "0";
    iframe.style.pointerEvents = "none";
    document.body.appendChild(iframe);

    let isOpen = false;

    function openIframe() {
        iframe.style.transform = "scale(1)";
        iframe.style.opacity = "1";
        iframe.style.pointerEvents = "auto";
        bubbleLogo.src = config.activeBubbleLogo || config.bubble.activeLogo;
        isOpen = true;
    }

    function closeIframe() {
        iframe.style.transform = "scale(0.8)";
        iframe.style.opacity = "0";
        iframe.style.pointerEvents = "none";
        bubbleLogo.src = config.bubbleLogo || config.bubble.logo;
        isOpen = false;
    }

    bubble.addEventListener("click", () => {
        isOpen ? closeIframe() : openIframe();
    });
})();
