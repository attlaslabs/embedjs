(function () {
    if (!window.embeddedChatbotConfig) {
        console.error("embeddedChatbotConfig non défini !");
        return;
    }

    const config = window.embeddedChatbotConfig;

    // Valeurs par défaut
    const defaultConfig = {
        size: {
            width: "450px",
            height: "630px",
        },
        bubble: {
            size: "52px", // Taille de la bulle
            logo: "https://221160ec90288b67394305daa4da6352.cdn.bubble.io/f1737572394496x724354314179088600/embedlogo.png",
            activeLogo: "https://221160ec90288b67394305daa4da6352.cdn.bubble.io/f1737572400429x992379412088643600/embedarrow.png",
            position: config.position === "left" ? "left" : "right",
        },
        domain: config.domain || "www.attlaslabs.com",
    };

    // Créer la bulle d'ouverture
    const bubble = document.createElement("div");
    bubble.style.position = "fixed";
    bubble.style.bottom = "20px";
    bubble.style[defaultConfig.bubble.position] = "20px";
    bubble.style.width = defaultConfig.bubble.size;
    bubble.style.height = defaultConfig.bubble.size;
    bubble.style.borderRadius = "50%";
    bubble.style.display = "flex";
    bubble.style.alignItems = "center";
    bubble.style.justifyContent = "center";
    bubble.style.cursor = "pointer";
    bubble.style.transition = "transform 0.3s ease";
    bubble.style.zIndex = "999999";

    // Ajouter l'image de la bulle
    const bubbleLogo = document.createElement("img");
    bubbleLogo.src = config.bubbleLogo || defaultConfig.bubble.logo;
    bubbleLogo.style.width = "100%";
    bubbleLogo.style.height = "100%";
    bubbleLogo.style.borderRadius = "50%";
    bubbleLogo.style.objectFit = "cover";
    bubble.appendChild(bubbleLogo);

    // Animation au hover
    bubble.addEventListener("mouseenter", () => {
        bubble.style.transform = "scale(1.1)";
    });

    bubble.addEventListener("mouseleave", () => {
        bubble.style.transform = "scale(1)";
    });

    document.body.appendChild(bubble);

    // Créer l'iframe
    const iframe = document.createElement("iframe");
    iframe.src = `https://${defaultConfig.domain}/version-test/iframe/${config.chatbotId}`;
    iframe.style.position = "fixed";
    iframe.style.bottom = `${parseInt(defaultConfig.bubble.size, 10) + 30}px`; // Ajuste pour être au-dessus de la bulle
    iframe.style[defaultConfig.bubble.position] = "10px";
    iframe.style.width = defaultConfig.size.width;
    iframe.style.height = defaultConfig.size.height;
    iframe.style.border = "0";
    iframe.style.zIndex = "999998"; // Moins que la bulle pour éviter les conflits
    iframe.style.boxShadow = "0px 4px 6px rgba(0, 0, 0, 0.1)";
    iframe.style.borderRadius = "10px";

    // Initial state (hidden and slightly below)
    iframe.style.transition = "opacity 0.3s ease, transform 0.3s ease"; // Smooth transitions
    iframe.style.transform = "translateY(20px)"; // Start slightly below
    iframe.style.opacity = "0"; // Start invisible
    iframe.style.pointerEvents = "none"; // Disable interactions when hidden
    document.body.appendChild(iframe);

    // Gérer les clics pour afficher ou masquer l'iframe
    let isOpen = false;
    bubble.addEventListener("click", () => {
        isOpen = !isOpen;
        if (isOpen) {
            iframe.style.transform = "translateY(0)"; // Move to original position
            iframe.style.opacity = "1"; // Fade in
            iframe.style.pointerEvents = "auto"; // Enable interactions
            bubbleLogo.src = config.activeBubbleLogo || defaultConfig.bubble.activeLogo; // Change bubble logo to active
        } else {
            iframe.style.transform = "translateY(20px)"; // Move slightly below
            iframe.style.opacity = "0"; // Fade out
            iframe.style.pointerEvents = "none"; // Disable interactions
            bubbleLogo.src = config.bubbleLogo || defaultConfig.bubble.logo; // Revert bubble logo to initial
        }
    });
})();
